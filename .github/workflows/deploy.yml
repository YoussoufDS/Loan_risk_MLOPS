name: ðŸš¢ Deploy & Validate API

on:
  # DÃ©clenchÃ© automatiquement aprÃ¨s Train ou Retrain
  workflow_run:
    workflows: ["ðŸš€ Train Models", "ðŸ”„ Retrain Models"]
    types: [completed]
    branches: [main]
  # DÃ©clenchement manuel possible
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Ne s'exÃ©cute QUE si le workflow prÃ©cÃ©dent a rÃ©ussi
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ðŸ—‚ï¸ Directories
        run: mkdir -p data/raw models/artifacts reports mlruns logs

      # RÃ©cupÃ©rer les modÃ¨les du dernier train/retrain
      - name: ðŸ“¥ Download latest models
        uses: actions/download-artifact@v4
        with:
          pattern: trained-models-*
          merge-multiple: true
          path: .
        continue-on-error: true

      # Tests unitaires
      - name: ðŸ§ª Run unit tests
        run: pytest tests/ -v --tb=short

      # DÃ©marrer l'API et vÃ©rifier
      - name: ðŸ” API health check
        env:
          MLFLOW_TRACKING_URI: "sqlite:///mlruns/mlflow.db"
        run: |
          uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          API_PID=$!

          echo "â³ Attente dÃ©marrage API..."
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… API prÃªte aprÃ¨s ${i}x2s"
              break
            fi
            sleep 2
          done

          # VÃ©rifier /health
          HEALTH=$(curl -sf http://localhost:8000/health)
          echo "Health: $HEALTH"

          # VÃ©rifier /model/info
          INFO=$(curl -sf http://localhost:8000/model/info)
          echo "Model info: $INFO"

          kill $API_PID 2>/dev/null || true

      # RÃ©sumÃ© final du pipeline complet
      - name: âœ… Pipeline summary
        run: |
          echo "## ðŸŽ‰ Pipeline MLOps Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ã‰tape | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Train / Retrain | âœ… SuccÃ¨s |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests pytest | âœ… PassÃ©s |" >> $GITHUB_STEP_SUMMARY
          echo "| API Health check | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          echo "| DÃ©ploiement local | âœ… ValidÃ© |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event.workflow_run.name || 'Manuel' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # Job de notification si deploy Ã©choue
  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: âŒ Notify failure
        run: |
          echo "## âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "Le dÃ©ploiement a Ã©chouÃ© aprÃ¨s Train/Retrain." >> $GITHUB_STEP_SUMMARY
          echo "VÃ©rifier les logs du job 'deploy' ci-dessus." >> $GITHUB_STEP_SUMMARY