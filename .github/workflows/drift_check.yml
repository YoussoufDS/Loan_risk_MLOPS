name: ğŸ” Drift Detection

on:
  schedule:
    - cron: "0 6 * * *"    # Chaque jour Ã  6h UTC
  workflow_dispatch:
    inputs:
      current_data_path:
        description: "Chemin vers les nouvelles donnÃ©es"
        default: "data/raw/Loan.csv"
        required: false

jobs:
  drift-check:
    runs-on: ubuntu-latest
    outputs:
      retrain_needed: ${{ steps.drift.outputs.retrain_needed }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - run: pip install -r requirements.txt

      - name: ğŸ“¥ Download latest models artifact
        uses: actions/download-artifact@v4
        with:
          name: trained-models-${{ github.run_number }}
          path: .
        continue-on-error: true  # OK si pas encore de modÃ¨le

      - name: ğŸ” Run drift detection
        id: drift
        run: |
          python -c "
          import json, sys
          sys.path.insert(0, '.')
          from src.drift_detection import detect_drift
          result = detect_drift('${{ github.event.inputs.current_data_path || 'data/raw/Loan.csv' }}')
          print(f'Drifted features: {result[\"drifted_features\"]}')
          print(f'Retrain needed: {result[\"retrain_needed\"]}')
          # Write GitHub output
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f'retrain_needed={str(result[\"retrain_needed\"]).lower()}\n')
          "

      - name: ğŸ“¤ Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ github.run_id }}
          path: reports/drift/
          retention-days: 90

      - name: ğŸ”” Notify if retrain needed
        if: steps.drift.outputs.retrain_needed == 'true'
        run: |
          echo "âš ï¸ DRIFT DETECTED â€” Triggering retrain workflow"
          echo "Retrain needed: true"

  # DÃ©clenche le rÃ©entraÃ®nement si drift dÃ©tectÃ©
  trigger-retrain:
    needs: drift-check
    if: needs.drift-check.outputs.retrain_needed == 'true'
    uses: ./.github/workflows/retrain.yml
    with:
      trigger: "drift_detected"