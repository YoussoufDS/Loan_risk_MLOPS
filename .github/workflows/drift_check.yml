name: ğŸ” Drift Detection

on:
  schedule:
    - cron: "0 6 * * *"    # Chaque jour Ã  6h UTC
  workflow_dispatch:

jobs:
  drift-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      retrain_needed: ${{ steps.drift.outputs.retrain_needed }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - run: pip install -r requirements.txt

      - name: ğŸ—‚ï¸ Directories
        run: mkdir -p data/processed data/reference reports/drift mlruns logs

      # Restaurer le snapshot de rÃ©fÃ©rence du dernier entraÃ®nement
      - name: ğŸ“¥ Restore reference snapshot & models
        uses: actions/download-artifact@v4
        with:
          pattern: trained-models-*
          merge-multiple: true
          path: .
        continue-on-error: true

      - name: ğŸ” Run drift detection
        id: drift
        run: |
          python -c "
          import json, sys
          sys.path.insert(0, '.')
          from src.drift_detection import detect_drift
          result = detect_drift('data/raw/Loan.csv', 'reports/drift/')
          print(f'Features driftees : {result[\"drifted_features\"]}')
          print(f'Retrain needed    : {result[\"retrain_needed\"]}')
          with open('drift_result.json', 'w') as f:
              json.dump(result, f, indent=2, default=str)
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'retrain_needed={str(result[\"retrain_needed\"]).lower()}\n')
          "

      - name: ğŸ“¤ Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ github.run_id }}
          path: |
            reports/drift/
            drift_result.json
          retention-days: 90

      - name: ğŸ“‹ Drift summary
        run: |
          echo "## Drift Detection ğŸ”" >> $GITHUB_STEP_SUMMARY
          python3 -c "
          import json
          with open('drift_result.json') as f:
              d = json.load(f)
          print(f'- Features analysees: {d[\"n_features_checked\"]}')
          print(f'- Features driftees: {d[\"n_drifted_features\"]}')
          print(f'- PSI moyen: {d[\"overall_mean_psi\"]:.4f}')
          print(f'- Retrain needed: **{d[\"retrain_needed\"]}**')
          " >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”” Alert if drift detected
        if: steps.drift.outputs.retrain_needed == 'true'
        run: echo "âš ï¸ DRIFT DETECTE â€” Declenchement du reentrainement automatique"

  trigger-retrain:
    needs: drift-check
    if: needs.drift-check.outputs.retrain_needed == 'true'
    uses: ./.github/workflows/retrain.yml
    with:
      trigger: "drift_detected"
    secrets: inherit